---
name: oke-node-pool-bump
description: Bump OKE node pool images based on a CSV report from the image-updates skill. Updates node pools to use newer OS images when available.
metadata:
  version: "1.0"
  category: "devops"
---

# OKE Node Pool Image Bump

Update OKE node pool images based on the CSV report generated by the image-updates skill.

## User Approval Requirements

**CRITICAL: This skill performs mutating operations that require explicit user approval.**

| Operation | Approval Required |
|-----------|-------------------|
| Dry-run (preview) | No |
| **Actual image bump** | **YES - MUST WAIT FOR USER CONFIRMATION** |

## When to Use This Skill

- "Bump the node pool images"
- "Apply the image updates from the CSV"
- "Update node images to latest"
- After running the image-updates skill and finding updates available

## Prerequisites

- **CSV**: Path to CSV report (from image-updates skill)
  - Default location: `oci_image_updates_report.csv`

## CLI Tool Reference

### Command
```bash
# Dry-run first (always do this)
make oke-node-pool-bump CSV=<path> DRY_RUN=true

# Actual bump (only after user approval)
make oke-node-pool-bump CSV=<path> [POLL_SECONDS=30]
```

### Parameters

| Parameter | Required | Description | Example |
|-----------|----------|-------------|---------|
| CSV | No | Path to CSV file (default: oci_image_updates_report.csv) | my_report.csv |
| POLL_SECONDS | No | Polling interval for work request status | 30 |
| DRY_RUN | No | Preview only | true |
| VERBOSE | No | Detailed output | true |

### Input CSV Format

The CSV file (from image-updates skill) contains:
```
host_name,region,compartment_id,current_image,new_image_name
node-1,us-phoenix-1,ocid1.compartment...,OKE-Ubuntu-20.04-2024.01,OKE-Ubuntu-20.04-2024.06
```

### Output Format

**Console output** showing:
- Node pools to be updated
- Current image -> New image for each
- Work request IDs and polling status
- Final success/failure status

### Output Interpretation

- Tool reads CSV and identifies which node pools need image updates
- Updates node pool configuration with new image
- Initiates cycling to apply new image to nodes
- Polls work requests until completion

## Procedure

1. **Ensure you have the CSV report**
   - If not, run: `make image-updates PROJECT=<project> STAGE=<stage>`

2. **Review the CSV file** to understand what will be updated:
   ```bash
   cat oci_image_updates_report.csv
   ```

3. **Always dry-run first**:
   ```bash
   make oke-node-pool-bump CSV=oci_image_updates_report.csv DRY_RUN=true
   ```

4. **Review dry-run output** and present to user:
   ```
   The following node pools will have their images updated:
   - Host: <name> (region: <region>)
     Current: <current_image>
     New: <new_image>
   ```

5. **APPROVAL CHECKPOINT**:
   ```
   Ready to bump node pool images:
   - <count> node pools will be updated
   - New images will be applied via node cycling

   Do you approve? (yes/no)
   ```

   **DO NOT PROCEED until user explicitly responds "yes"**

6. **Execute** (only after approval):
   ```bash
   make oke-node-pool-bump CSV=oci_image_updates_report.csv
   ```

7. **Monitor progress** - the tool polls work requests and reports status

## Error Handling

| Error | Cause | Solution |
|-------|-------|----------|
| Image not found | Image name doesn't exist in compartment | Verify image name in OCI Console |
| Node pool not found | Instance not part of OKE pool | May be standalone instance, handle separately |
| Work request failed | OCI operation error | Check work request details in OCI Console |

## Summary Report

After execution, report:
- Number of node pools updated
- Images changed (old -> new)
- Work request IDs
- Any failures or skipped entries
