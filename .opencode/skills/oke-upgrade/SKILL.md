---
name: oke-upgrade
description: Trigger OKE cluster control plane upgrades using a previously generated HTML report. Use after generating a version report to upgrade cluster control planes to a target Kubernetes version.
metadata:
  version: "1.0"
  category: "devops"
---

# OKE Cluster Upgrade

Trigger OKE cluster control plane upgrades based on the HTML report generated by oke-version-report.

## User Approval Requirements

**CRITICAL: This skill performs mutating operations that require explicit user approval.**

| Operation | Approval Required |
|-----------|-------------------|
| Dry-run (preview) | No |
| **Actual upgrade** | **YES - MUST WAIT FOR USER CONFIRMATION** |

## When to Use This Skill

- "Upgrade the OKE clusters"
- "Upgrade control planes to version 1.34.1"
- "Apply the upgrades from the report"
- After generating a version report showing available upgrades

## Prerequisites

Gather from the user:
- **REPORT**: Path to HTML report (from oke-version-report skill)

Optional filters:
- **TARGET_VERSION**: Specific version to upgrade to
- **PROJECT**: Filter by project name
- **STAGE**: Filter by stage
- **REGION_FILTER**: Filter by region
- **CLUSTER**: Filter by cluster OCID or name

## CLI Tool Reference

### Command
```bash
# Dry-run first (always do this)
make oke-upgrade REPORT=<path> DRY_RUN=true

# Actual upgrade (only after user approval)
make oke-upgrade REPORT=<path> [TARGET_VERSION=<version>] [PROJECT=<name>] [STAGE=<env>] [REGION_FILTER=<region>] [CLUSTER=<ocid_or_name>]
```

### Parameters

| Parameter | Required | Description | Example |
|-----------|----------|-------------|---------|
| REPORT | Yes | Path to HTML report file | reports/oke_versions_my-project_dev.html |
| TARGET_VERSION | No | Target K8s version (uses latest available if not specified) | 1.34.1 |
| PROJECT | No | Filter by project | my-project |
| STAGE | No | Filter by stage | dev |
| REGION_FILTER | No | Filter by region | us-phoenix-1 |
| CLUSTER | No | Filter by cluster OCID or name | my-cluster |
| DRY_RUN | No | Preview only without making changes | true |
| VERBOSE | No | Enable detailed output | true |

### Output Format

**Console output** showing:
- List of clusters to be upgraded
- Current version -> Target version for each
- Work request IDs for initiated upgrades
- Success/failure status summary

### Output Interpretation

- **Work Request ID**: Use to track upgrade progress in OCI Console
- **DRY_RUN=true output**: Shows what WOULD be upgraded without making changes
- **Skipped clusters**: Already at target version or no upgrades available

## Procedure

1. **Always dry-run first**:
   ```bash
   make oke-upgrade REPORT=reports/oke_versions_<project>_<stage>.html DRY_RUN=true
   ```

2. **Review the dry-run output** and present to user:
   ```
   The following clusters will be upgraded:
   - Cluster: <name> (region: us-phoenix-1)
     Current: v1.33.0 -> Target: v1.34.1
   ```

3. **APPROVAL CHECKPOINT**:
   ```
   Do you approve upgrading these cluster control planes? (yes/no)

   Note: This will make the Kubernetes API briefly unavailable during upgrade.
   Duration: Typically 10-20 minutes per cluster.
   ```

   **DO NOT PROCEED until user explicitly responds "yes"**

4. **Execute the upgrade** (only after approval):
   ```bash
   make oke-upgrade REPORT=reports/oke_versions_<project>_<stage>.html
   ```

5. **Report results**:
   - Work request IDs for tracking
   - Expected completion time
   - Next steps: "After control plane upgrade completes, use oke-upgrade-node-pools skill"

## Error Handling

| Error | Cause | Solution |
|-------|-------|----------|
| Cluster not ACTIVE | Pending operations | Wait for current operations to complete |
| Version not available | Invalid target version | Check available_upgrades in the report |
| Authentication expired | Session timeout | Re-run `oci session authenticate` |

## Summary Report

After execution, report:
- Number of clusters upgraded
- Work request IDs for each upgrade
- Reminder to wait for completion before upgrading node pools
- Command to regenerate report to verify completion:
  ```bash
  make oke-version-report PROJECT=<project> STAGE=<stage>
  ```
